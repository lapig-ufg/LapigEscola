<!-- templates/admin/base_site.html -->
{% extends "admin/base.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/ckeditor-map-plugin.css' %}">
<link rel="stylesheet" href="{% static 'css/lapig.css' %}">
<style>
    /* Estilos para o bot√£o de inserir mapa - Compat√≠vel com Django Admin */
    .map-insert-controls {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 12px;
        margin: 8px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        font-family: "Roboto","Lucida Grande","DejaVu Sans","Bitstream Vera Sans",Verdana,Arial,sans-serif;
        display: block !important;
        width: 100% !important;
        box-sizing: border-box !important;
        clear: both !important;
    }

    .map-insert-controls label {
        display: block !important;
        margin: 0 0 10px 0 !important;
        font-weight: 600 !important;
        color: var(--body-fg, #333) !important;
        font-size: 13px !important;
        line-height: 1.2 !important;
    }

    .map-buttons {
        display: flex !important;
        gap: 8px !important;
        margin-bottom: 8px !important;
        flex-wrap: wrap !important;
    }

    .insert-map-btn,
    .toggle-html-btn {
        display: inline-block !important;
        border: 1px solid var(--button-bg, #79aec8) !important;
        padding: 8px 16px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        font-size: 13px !important;
        font-weight: 400 !important;
        text-decoration: none !important;
        transition: all 0.15s ease-in-out !important;
        font-family: "Roboto","Lucida Grande","DejaVu Sans","Bitstream Vera Sans",Verdana,Arial,sans-serif !important;
        flex: 1 !important;
        text-align: center !important;
    }

    .insert-map-btn {
        background: var(--button-bg, #79aec8) !important;
        color: var(--button-fg, #fff) !important;
    }

    .toggle-html-btn {
        background: var(--body-bg, #fff) !important;
        color: var(--body-fg, #333) !important;
    }

    .insert-map-btn:hover {
        background: var(--button-hover-bg, #609ab6) !important;
        border-color: var(--button-hover-bg, #609ab6) !important;
    }

    .toggle-html-btn:hover {
        background: var(--darkened-bg, #f5f5f5) !important;
        border-color: var(--button-bg, #79aec8) !important;
    }

    .insert-map-btn:focus,
    .toggle-html-btn:focus {
        outline: 2px solid var(--focus-color, #79aec8) !important;
        outline-offset: -2px !important;
    }

    .map-status {
        display: block !important;
        color: var(--body-quiet-color, #666) !important;
        font-size: 12px !important;
        font-style: italic !important;
        margin-top: 4px !important;
        min-height: 16px !important;
        font-family: "Roboto","Lucida Grande","DejaVu Sans","Bitstream Vera Sans",Verdana,Arial,sans-serif !important;
    }

    .map-status.success {
        color: var(--success-fg, #28a745) !important;
        font-weight: 500 !important;
    }

    .map-status.error {
        color: var(--error-fg, #ba2121) !important;
        font-weight: 500 !important;
    }

    /* Garante que o editor fique abaixo do bot√£o */
    .ck-editor-container {
        display: block !important;
        width: 100% !important;
        clear: both !important;
        margin-top: 8px !important;
    }

    /* Estilos para .map-embed dentro do CKEditor - Comportamento como imagem */
    .ck-content .map-embed {
        display: inline-block !important;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
        border: 2px solid #2196f3 !important;
        border-radius: 8px !important;
        padding: 12px 16px !important;
        margin: 16px 8px !important;
        font-family: "Roboto", Arial, sans-serif !important;
        font-size: 14px !important;
        color: #1976d2 !important;
        position: relative !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        min-width: 200px !important;
        max-width: 400px !important;
        text-align: center !important;
        vertical-align: top !important;

        /* Comportamento como imagem - permite posicionamento */
        float: none !important;
        clear: none !important;

        /* N√ÉO edit√°vel e N√ÉO mov√≠vel */
        user-select: none !important;
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;

        /* Bloqueia edi√ß√£o */
        pointer-events: none !important;

        /* Espa√ßamento adequado para texto ao redor */
        line-height: 1 !important;
    }

    /* Varia√ß√µes de posicionamento - 50% para esquerda/direita */
    .ck-content .map-embed.align-left {
        float: left !important;
        margin: 16px 16px 16px 0 !important;
        clear: left !important;
        width: 50% !important;
        max-width: 50% !important;
    }

    .ck-content .map-embed.align-right {
        float: right !important;
        margin: 16px 0 16px 16px !important;
        clear: right !important;
        width: 50% !important;
        max-width: 50% !important;
    }

    .ck-content .map-embed.align-center {
        display: block !important;
        margin: 20px auto !important;
        float: none !important;
        clear: both !important;
        width: 100% !important;
        max-width: 100% !important;
    }

    .ck-content .map-embed:hover {
        background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important;
        border-color: #1976d2 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4) !important;
        z-index: 10 !important;
    }

    /* Estado de sele√ß√£o no CKEditor */
    .ck-content .map-embed.ck-widget_selected,
    .ck-content .map-embed:focus {
        outline: 3px solid #2196f3 !important;
        outline-offset: 2px !important;
        box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4) !important;
    }

    /* Indicador de movimento */
    .ck-content .map-embed::after {
        content: "Slug: " attr(data-map-slug) " ‚Ä¢ Clique e arraste para mover" !important;
        font-size: 12px !important;
        opacity: 0.8 !important;
        font-style: italic !important;
        display: block !important;
        margin-top: 4px !important;
    }

    .ck-content .map-embed::before {
        content: "üó∫Ô∏è " attr(data-map-title) !important;
        font-weight: 600 !important;
        display: block !important;
        margin-bottom: 4px !important;
    }

    .ck-content .map-embed::after {
        content: "Slug: " attr(data-map-slug) !important;
        font-size: 12px !important;
        opacity: 0.8 !important;
        font-style: italic !important;
    }

    /* Estilos para modo HTML - textarea */
    textarea.django_ckeditor_5 {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
        line-height: 1.5 !important;
        tab-size: 2 !important;
    }

    /* Apollo Theme Integration - Dark Mode */
    :root.app-dark .ck-content .map-embed,
    .app-dark .ck-content .map-embed,
    @media (prefers-color-scheme: dark) {
        .map-insert-controls {
            background: var(--surface-card, #2d2d2d);
            border-color: var(--surface-border, #404040);
        }

        .ck-content .map-embed {
            background: var(--surface-card, #263238) !important;
            border-color: var(--primary-color, #4fc3f7) !important;
            color: var(--text-color, #81d4fa) !important;
            box-shadow: var(--sidebar-shadow, none) !important;
        }

        .ck-content .map-embed:hover {
            background: var(--surface-hover, #37474f) !important;
            border-color: var(--primary-color, #29b6f6) !important;
        }
    }

    /* Apollo Theme Integration - Light Mode */
    :root .ck-content .map-embed {
        background: linear-gradient(135deg, var(--surface-card, #e3f2fd) 0%, var(--surface-100, #bbdefb) 100%) !important;
        border-color: var(--primary-color, #2196f3) !important;
        color: var(--text-color, #1976d2) !important;
        box-shadow: var(--card-shadow, 0 4px 20px rgba(0, 0, 0, 0.1)) !important;
    }

    :root .ck-content .map-embed:hover {
        background: linear-gradient(135deg, var(--surface-100, #bbdefb) 0%, var(--surface-200, #90caf9) 100%) !important;
        border-color: var(--primary-600, #1976d2) !important;
    }
</style>
{% endblock %}



{% block footer %}
{{ block.super }}
<script>
(function() {
    'use strict';

    console.log('üöÄ Inicializando sistema de inser√ß√£o de mapas...');

    // Armazena inst√¢ncias do CKEditor
    window.editorInstances = window.editorInstances || {};

    /**
     * Detecta editores CKEditor e adiciona bot√µes de inserir mapa
     */
    function addMapButtonsToCKEditors() {
        // Busca especificamente por form-rows que s√£o campos de texto CKEditor
        const textFormRows = document.querySelectorAll('.form-row.field-texto');

        console.log('üìù Encontradas', textFormRows.length, 'form-rows com field-texto');

        textFormRows.forEach((formRow, index) => {
            // Verifica se cont√©m um ck-editor-container
            const ckEditorContainer = formRow.querySelector('.ck-editor-container');
            if (!ckEditorContainer) {
                console.log('‚è≠Ô∏è Form-row n√£o tem ck-editor-container');
                return;
            }

            // Verifica se j√° tem o bot√£o dentro da form-row
            if (formRow.querySelector('.map-insert-controls')) {
                console.log(`‚è≠Ô∏è Bot√£o j√° existe na form-row`);
                return;
            }

            // Busca o textarea
            let textarea = ckEditorContainer.querySelector('textarea[name]');
            if (!textarea) {
                textarea = ckEditorContainer.querySelector('textarea[data-django-ckeditor5]');
            }
            if (!textarea) {
                textarea = ckEditorContainer.querySelector('textarea');
            }

            if (!textarea) {
                console.warn('‚ö†Ô∏è Textarea n√£o encontrada no .ck-editor-container');
                return;
            }

            const fieldName = textarea.name || textarea.id || `editor_${index}`;
            console.log('‚ú® Adicionando bot√£o de mapa para campo:', fieldName);

            // Cria o container do bot√£o
            const mapControls = document.createElement('div');
            mapControls.className = 'map-insert-controls';
            mapControls.innerHTML = `
                <label>üó∫Ô∏è Inserir Mapa:</label>
                <div class="map-buttons">
                    <button type="button" class="insert-map-btn" data-field="${fieldName}">
                        <span>Selecionar Mapa</span>
                    </button>
                    <button type="button" class="toggle-html-btn" data-field="${fieldName}">
                        <span>üìù Ver HTML</span>
                    </button>
                </div>
                <span class="map-status" id="map-status-${index}"></span>
            `;

            // Encontra o .flex-container que cont√©m o ck-editor-container
            const flexContainer = ckEditorContainer.closest('.flex-container');

            if (flexContainer) {
                // Insere o bot√£o ANTES do .flex-container
                flexContainer.parentNode.insertBefore(mapControls, flexContainer);
                console.log('‚úÖ Bot√£o inserido antes do .flex-container');
            } else {
                // Fallback: inserir antes do ck-editor-container
                const parentOfCkEditor = ckEditorContainer.parentNode;
                parentOfCkEditor.insertBefore(mapControls, ckEditorContainer);
                console.log('‚úÖ Bot√£o inserido antes do .ck-editor-container (fallback)');
            }

            // Adiciona eventos aos bot√µes
            const insertButton = mapControls.querySelector('.insert-map-btn');
            const toggleButton = mapControls.querySelector('.toggle-html-btn');
            const statusSpan = mapControls.querySelector('.map-status');

            if (insertButton && statusSpan) {
                insertButton.addEventListener('click', function() {
                    handleMapInsertion(textarea, statusSpan, fieldName, index);
                });
            } else {
                console.warn('‚ö†Ô∏è Bot√£o ou status span n√£o encontrado:', { insertButton, statusSpan });
            }

            if (toggleButton) {
                toggleButton.addEventListener('click', function() {
                    handleHtmlToggle(ckEditorContainer, toggleButton);
                });
            }

            // Armazena refer√™ncia do editor para sincroniza√ß√£o no save
            editorReferences.set(fieldName, {
                textarea: textarea,
                container: ckEditorContainer,
                fieldName: fieldName
            });

            // Registra callback para quando o editor estiver pronto (Django CKEditor 5)
            const editorId = textarea.id || textarea.name || fieldName;
            if (window.ckeditorRegisterCallback && typeof window.ckeditorRegisterCallback === 'function') {
                window.ckeditorRegisterCallback(editorId, function(editor) {
                    console.log(`üéØ Callback registrado para editor ${editorId}`);
                    // Armazena a inst√¢ncia para uso posterior
                    window.editorInstances = window.editorInstances || {};
                    window.editorInstances[editorId] = editor;
                });
            }
        });
    }

    /**
     * Busca a inst√¢ncia do CKEditor para um textarea espec√≠fico usando a API correta do Django CKEditor 5
     */
    function getCKEditorInstance(textarea, fieldName) {
        const editorId = textarea.id || textarea.name || fieldName;

        // 1. M√âTODO CORRETO: Usa window.editors (Django CKEditor 5)
        if (window.editors && window.editors[editorId]) {
            console.log(`‚úÖ Editor encontrado via window.editors para ${editorId}`);
            return window.editors[editorId];
        }

        // 2. Busca alternativa caso o ID seja diferente
        if (window.editors) {
            for (const [key, editor] of Object.entries(window.editors)) {
                if (key.includes(fieldName) || fieldName.includes(key)) {
                    console.log(`‚úÖ Editor encontrado via busca alternativa: ${key} para ${editorId}`);
                    return editor;
                }
            }
        }

        // 3. Busca no container .ck-editor-container (backup)
        const ckContainer = textarea.closest('.ck-editor-container');
        if (ckContainer) {
            const ckEditor = ckContainer.querySelector('.ck-editor');
            if (ckEditor && ckEditor.ckeditorInstance) {
                console.log(`‚úÖ Editor encontrado via .ck-editor-container para ${editorId}`);
                return ckEditor.ckeditorInstance;
            }
        }

        // 4. Lista todos os editores dispon√≠veis para debug
        if (window.editors) {
            console.log('üìù Editores dispon√≠veis:', Object.keys(window.editors));
        }

        console.warn(`‚ö†Ô∏è Editor CKEditor n√£o encontrado para ${editorId}. Usando inser√ß√£o direta no textarea.`);
        return null;
    }

    /**
     * Manipula a inser√ß√£o do mapa
     */
    async function handleMapInsertion(textarea, statusSpan, fieldName, index) {
        try {
            statusSpan.textContent = 'Carregando mapas...';
            statusSpan.className = 'map-status';

            // Tenta diferentes endpoints para buscar mapas
            let response;
            const endpoints = [
                '/api/maps/list-for-editor',
                '/api/v1/maps/list-for-editor',
                '/escola/api/maps/list-for-editor'
            ];

            let maps = null;
            for (const endpoint of endpoints) {
                try {
                    response = await fetch(endpoint);
                    if (response.ok) {
                        maps = await response.json();
                        console.log(`‚úÖ Mapas carregados via ${endpoint}:`, maps);
                        break;
                    }
                } catch (e) {
                    console.warn(`Endpoint ${endpoint} falhou:`, e);
                    continue;
                }
            }

            if (!maps || maps.length === 0) {
                statusSpan.textContent = 'Nenhum mapa dispon√≠vel';
                statusSpan.className = 'map-status error';
                return;
            }

            statusSpan.textContent = '';

            // Abre o seletor de mapas
            const selectedMap = await openMapSelector(maps);

            if (selectedMap) {
                // Sempre usar inser√ß√£o direta no textarea com sincroniza√ß√£o do CKEditor
                // Esta √© a abordagem mais confi√°vel para o Django CKEditor 5
                insertMapIntoTextarea(textarea, selectedMap);

                statusSpan.textContent = `‚úì Mapa "${selectedMap.titulo}" inserido!`;
                statusSpan.className = 'map-status success';

                setTimeout(() => {
                    statusSpan.textContent = '';
                    statusSpan.className = 'map-status';
                }, 3000);
            }

        } catch (error) {
            console.error('Erro ao inserir mapa:', error);
            statusSpan.textContent = '‚úó Erro ao carregar mapas';
            statusSpan.className = 'map-status error';
            setTimeout(() => {
                statusSpan.textContent = '';
                statusSpan.className = 'map-status';
            }, 3000);
        }
    }


    /**
     * Cria o HTML do mapa com par√°grafo para continuar escrevendo
     */
    function createMapHtml(mapData) {
        const attrs = [
            `data-map-slug="${mapData.slug || ''}"`,
            `data-map-id="${mapData.id || ''}"`,
            `data-map-title="${escapeHtml(mapData.titulo || 'Mapa')}"`,
            `data-show-header="${mapData.showHeader !== false}"`,
            `data-header-theme="${mapData.theme || 'primary'}"`,
            `contenteditable="false"`  // Bloqueia edi√ß√£o
        ];

        if (mapData.height) {
            attrs.push(`data-height="${mapData.height}"`);
        }

        // Adiciona classe de alinhamento se especificada
        let classes = 'map-embed';
        if (mapData.align) {
            classes += ` ${mapData.align}`;
        }

        // Retorna mapa + par√°grafo vazio para continuar escrevendo
        return `<div class="${classes}" ${attrs.join(' ')}></div><p></p>`;
    }

    /**
     * Insere o mapa diretamente no textarea (fallback)
     */
    function insertMapIntoTextarea(textarea, mapData) {
        const mapHtml = createMapHtml(mapData);

        const currentValue = textarea.value || '';
        const cursorPos = textarea.selectionStart || currentValue.length;

        const newValue = currentValue.slice(0, cursorPos) + '\n' + mapHtml + '\n' + currentValue.slice(cursorPos);
        textarea.value = newValue;

        // Define a nova posi√ß√£o do cursor
        const newCursorPos = cursorPos + mapHtml.length + 2;
        try {
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        } catch (e) {
            // Ignora erro de sele√ß√£o em alguns navegadores
        }

        // M√âTODO MAIS DIRETO: For√ßa a sincroniza√ß√£o imediatamente
        // Dispara eventos que o Django CKEditor 5 reconhece
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
        textarea.dispatchEvent(new Event('change', { bubbles: true }));

        // Tenta usar a API correta do Django CKEditor 5
        const editorId = textarea.id || textarea.name;
        const editor = getCKEditorInstance(textarea, editorId);

        if (editor && editor.setData) {
            try {
                // Usa a inst√¢ncia correta do editor
                editor.setData(textarea.value);
                console.log('‚úÖ CKEditor 5 atualizado via API correta do Django');
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao atualizar CKEditor via API:', e);
                // Fallback para m√©todo DOM
                tryDOMUpdate();
            }
        } else {
            // Fallback para m√©todo DOM se a API n√£o estiver dispon√≠vel
            tryDOMUpdate();
        }

        function tryDOMUpdate() {
            const ckContainer = textarea.closest('.ck-editor-container');
            if (ckContainer) {
                const editorDiv = ckContainer.querySelector('.ck-editor');
                if (editorDiv && editorDiv.ckeditorInstance) {
                    try {
                        editorDiv.ckeditorInstance.setData(textarea.value);
                        console.log('‚úÖ CKEditor 5 atualizado via DOM fallback');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Fallback DOM tamb√©m falhou:', e);
                    }
                }
            }
        }

        // Marca o formul√°rio como modificado (Django Admin)
        if (window.django && window.django.admin) {
            window.django.admin.initialFormData = null;
        }

        console.log('‚úÖ Mapa inserido no textarea com sincroniza√ß√£o for√ßada');
    }

    /**
     * Abre modal de sele√ß√£o de mapas
     */
    function openMapSelector(maps) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div');
            overlay.className = 'ck-map-modal-overlay';

            const modal = document.createElement('div');
            modal.className = 'ck-map-modal';
            modal.innerHTML = `
                <div class="ck-map-modal-header">
                    <h3>Selecionar Mapa</h3>
                    <button class="ck-map-modal-close" type="button" aria-label="Fechar">&times;</button>
                </div>
                <div class="ck-map-modal-body">
                    <div class="ck-map-search">
                        <input type="text" placeholder="Buscar mapa..." id="mapSearchInput">
                    </div>
                    <div class="ck-map-list" id="mapList"></div>
                </div>
                <div class="ck-map-modal-footer">
                    <div class="ck-map-options">
                        <label>
                            <input type="checkbox" id="showHeaderCheckbox" checked>
                            Mostrar cabe√ßalho
                        </label>
                        <div class="ck-map-height">
                            <label for="mapHeight">Altura:</label>
                            <input type="text" id="mapHeight" placeholder="ex: 400px">
                        </div>
                        <div class="ck-map-align">
                            <label for="mapAlign">Posi√ß√£o:</label>
                            <select id="mapAlign">
                                <option value="">Inline (padr√£o)</option>
                                <option value="align-left">Esquerda</option>
                                <option value="align-center">Centro</option>
                                <option value="align-right">Direita</option>
                            </select>
                        </div>
                        <div class="ck-map-theme">
                            <label for="mapTheme">Tema do Cabe√ßalho:</label>
                            <select id="mapTheme">
                                <option value="primary">Primary (Padr√£o)</option>
                                <option value="success">Success (Verde)</option>
                                <option value="info">Info (Azul)</option>
                                <option value="warning">Warning (Amarelo)</option>
                                <option value="danger">Danger (Vermelho)</option>
                                <option value="secondary">Secondary (Cinza)</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="ck-map-modal-cancel">Cancelar</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const mapList = modal.querySelector('#mapList');

            const renderMaps = (filteredMaps) => {
                mapList.innerHTML = filteredMaps.map(map => `
                    <div class="ck-map-item" data-slug="${map.slug}" data-id="${map.id}" data-title="${escapeHtml(map.titulo)}">
                        <div class="ck-map-item-icon">üó∫Ô∏è</div>
                        <div class="ck-map-item-content">
                            <div class="ck-map-item-title">${escapeHtml(map.titulo)}</div>
                            <div class="ck-map-item-meta">
                                <span class="ck-map-item-slug">${escapeHtml(map.slug)}</span>
                                ${map.layers_count ? `<span class="ck-map-item-layers">${map.layers_count} camadas</span>` : ''}
                            </div>
                            ${map.descricao ? `<div class="ck-map-item-desc">${escapeHtml(map.descricao)}</div>` : ''}
                        </div>
                    </div>
                `).join('');

                mapList.querySelectorAll('.ck-map-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const showHeader = modal.querySelector('#showHeaderCheckbox').checked;
                        const height = modal.querySelector('#mapHeight').value.trim();
                        const align = modal.querySelector('#mapAlign').value;
                        const theme = modal.querySelector('#mapTheme').value;

                        resolve({
                            slug: item.dataset.slug,
                            id: item.dataset.id,
                            titulo: item.dataset.title,
                            showHeader: showHeader,
                            height: height || null,
                            align: align || null,
                            theme: theme || 'primary'
                        });
                        document.body.removeChild(overlay);
                    });
                });
            };

            renderMaps(maps);

            // Busca
            const searchInput = modal.querySelector('#mapSearchInput');
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = maps.filter(map =>
                    map.titulo.toLowerCase().includes(term) ||
                    map.slug.toLowerCase().includes(term) ||
                    (map.descricao && map.descricao.toLowerCase().includes(term))
                );
                renderMaps(filtered);
            });

            // Fechar
            const close = () => {
                document.body.removeChild(overlay);
                resolve(null);
            };

            modal.querySelector('.ck-map-modal-close').addEventListener('click', close);
            modal.querySelector('.ck-map-modal-cancel').addEventListener('click', close);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) close();
            });
        });
    }

    /**
     * Alterna entre modo visual e HTML no CKEditor
     */
    function handleHtmlToggle(ckEditorContainer, toggleButton) {
        const editor = ckEditorContainer.querySelector('.ck-editor');
        const textarea = ckEditorContainer.querySelector('textarea');

        if (!editor || !textarea) {
            console.warn('‚ö†Ô∏è Editor ou textarea n√£o encontrado para toggle HTML');
            return;
        }

        const isHtmlMode = ckEditorContainer.classList.contains('html-mode');

        if (isHtmlMode) {
            // Volta para modo visual
            editor.style.display = 'block';
            textarea.style.display = 'none';
            ckEditorContainer.classList.remove('html-mode');
            toggleButton.innerHTML = '<span>üìù Ver HTML</span>';

            // Sincroniza o conte√∫do do textarea para o editor
            const editorInstance = getCKEditorInstance(textarea, textarea.name);
            if (editorInstance && editorInstance.setData) {
                editorInstance.setData(textarea.value);
            }
        } else {
            // Vai para modo HTML
            editor.style.display = 'none';
            textarea.style.display = 'block';
            textarea.style.width = '100%';
            textarea.style.height = '400px';
            textarea.style.fontFamily = "'Consolas', 'Monaco', 'Courier New', monospace";
            textarea.style.fontSize = '14px';
            textarea.style.border = '1px solid #ddd';
            textarea.style.padding = '15px';
            textarea.style.lineHeight = '1.6';
            textarea.style.backgroundColor = '#f8f9fa';
            textarea.style.borderRadius = '4px';
            textarea.style.resize = 'vertical';
            ckEditorContainer.classList.add('html-mode');
            toggleButton.innerHTML = '<span>üëÅÔ∏è Ver Visual</span>';

            // Sincroniza o conte√∫do do editor para o textarea
            const editorInstance = getCKEditorInstance(textarea, textarea.name);
            if (editorInstance && editorInstance.getData) {
                textarea.value = editorInstance.getData();
            }
        }
    }

    /**
     * Escapa HTML
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Observa mudan√ßas no DOM para detectar novos editores
     */
    function observeNewEditors() {
        const observer = new MutationObserver(function(mutations) {
            let shouldCheck = false;

            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && (
                        (node.classList?.contains('form-row') && node.classList?.contains('field-texto')) ||
                        node.classList?.contains('ck-editor-container') ||
                        node.querySelector?.('.form-row.field-texto') ||
                        node.querySelector?.('.ck-editor-container')
                    )) {
                        shouldCheck = true;
                    }
                });
            });

            if (shouldCheck) {
                console.log('üîÑ Novos form-rows.field-texto detectados, adicionando bot√µes...');
                setTimeout(addMapButtonsToCKEditors, 500);
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    // Flag para controlar inicializa√ß√£o
    let initialized = false;

    // Armazena refer√™ncias dos editores para sincroniza√ß√£o
    let editorReferences = new Map();

    /**
     * For√ßa a sincroniza√ß√£o usando a forma padr√£o do Django CKEditor 5
     */
    function forceSync() {
        console.log('üîÑ For√ßando sincroniza√ß√£o do Django CKEditor 5...');

        // M√©todo 1: Usa o evento padr√£o do Django CKEditor 5
        editorReferences.forEach((editorRef, fieldName) => {
            const { textarea } = editorRef;

            // Dispara eventos que o Django CKEditor 5 escuta
            textarea.dispatchEvent(new Event('change', { bubbles: true }));
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            textarea.dispatchEvent(new Event('blur', { bubbles: true }));
        });

        // M√©todo 2: For√ßa updateSourceElement se dispon√≠vel
        if (window.CKEDITOR && window.CKEDITOR.instances) {
            Object.keys(window.CKEDITOR.instances).forEach(instanceName => {
                const instance = window.CKEDITOR.instances[instanceName];
                if (instance.updateElement) {
                    instance.updateElement();
                    console.log(`‚úÖ updateElement chamado para ${instanceName}`);
                }
            });
        }

        // M√©todo 3: Para CKEditor 5, for√ßa a sincroniza√ß√£o via evento personalizado
        document.dispatchEvent(new CustomEvent('django-ckeditor5-sync'));

        console.log('‚úÖ Sincroniza√ß√£o for√ßada');
    }

    /**
     * Setup simples de sincroniza√ß√£o
     */
    function setupSimpleFormSync() {
        // Intercepta TODOS os cliques de bot√µes de save do Django Admin
        document.addEventListener('click', function(e) {
            if (e.target.matches('input[name="_save"], input[name="_continue"], input[name="_addanother"], button[type="submit"]')) {
                console.log('üíæ Bot√£o de save detectado, sincronizando...');
                setTimeout(() => forceSync(), 50);
            }
        });

        // Tamb√©m intercepta o submit do formul√°rio como backup
        document.addEventListener('submit', function(e) {
            if (e.target.matches('form')) {
                console.log('üíæ Submit detectado, sincronizando...');
                forceSync();
            }
        });

        console.log('‚úÖ Sincroniza√ß√£o simples configurada');
    }

    /**
     * Bloqueia edi√ß√£o dentro dos mapas e configura navega√ß√£o
     */
    function setupMapBlockBehavior() {
        // Bloqueia edi√ß√£o dentro dos mapas
        document.addEventListener('keydown', function(e) {
            if (e.target.closest('.ck-content .map-embed')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });

        document.addEventListener('input', function(e) {
            if (e.target.closest('.ck-content .map-embed')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });

        console.log('‚úÖ Edi√ß√£o dos mapas bloqueada');
    }

    /**
     * Inicializa√ß√£o principal
     */
    function init() {
        if (initialized) {
            console.log('‚è≠Ô∏è Sistema j√° inicializado, pulando...');
            return;
        }

        console.log('üîß Iniciando sistema de mapas para CKEditor...');
        initialized = true;

        // Executa ap√≥s o DOM estar pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(() => {
                    addMapButtonsToCKEditors();
                    observeNewEditors();
                    setupSimpleFormSync();
                    setupMapBlockBehavior();
                }, 500);
            });
        } else {
            setTimeout(() => {
                addMapButtonsToCKEditors();
                observeNewEditors();
                setupSimpleFormSync();
                setupMapBlockBehavior();
            }, 500);
        }

        // Tamb√©m tenta ap√≥s um tempo maior para editores que carregam mais tarde
        setTimeout(() => {
            addMapButtonsToCKEditors();
        }, 2000);

        console.log('‚úÖ Sistema de inser√ß√£o de mapas inicializado');
    }

    // Hook para django-ckeditor-5 se dispon√≠vel
    if (window.django && window.django.ckeditor5) {
        window.django.ckeditor5.onReady = function() {
            console.log('üéØ CKEditor5 pronto, adicionando bot√µes de mapa...');
            setTimeout(addMapButtonsToCKEditors, 100);
        };
    }

    // Inicia o sistema
    init();
})();
</script>
{% endblock %}
